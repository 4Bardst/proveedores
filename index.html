<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Proveedores de MCA</title>
    <meta name="description" content="Directorio de negocios y proveedores locales de MCA que venden a otras ciudades.">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Un gris un poco más suave */
        }
        .card-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 1.5rem;
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="antialiased">

    <header class="bg-white shadow-sm">
        <div class="container mx-auto px-6 py-4">
            <h1 class="text-3xl font-bold text-gray-800">Directorio de MCA</h1>
            <p class="text-gray-600 mt-1">Negocios locales listos para vender más allá de nuestras fronteras.</p>
        </div>
    </header>

    <main class="container mx-auto px-6 py-8">
        <div class="mb-8 p-4 bg-white rounded-lg shadow">
            <div class="flex flex-col md:flex-row gap-4">
                <input type="text" id="searchInput" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-teal-500" placeholder="Buscar por nombre o descripción...">
                <select id="categoryFilter" class="w-full md:w-64 px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-teal-500">
                    <option value="all">Todas las categorías</option>
                </select>
            </div>
        </div>

        <div id="loading" class="text-center py-10"><p class="text-gray-500 text-lg">Cargando proveedores...</p></div>
        <div id="card-container" class="card-container"></div>
        <div id="no-results" class="hidden text-center py-10"><p class="text-gray-500 text-lg">No se encontraron resultados.</p></div>
    </main>

    <footer class="bg-white mt-12 py-6">
        <div class="container mx-auto px-6 text-center text-gray-500">
            <p>&copy; 2025 MCA | Creado con ❤️ para nuestra comunidad.</p>
            <a href="https://docs.google.com/forms/d/e/1FAIpQLSf0VcpyBe3WnIw0NqQya8MzFldco9crDaffTcgpfDNfvUj3lg/viewform?usp=header" target="_blank" class="inline-block mt-4 px-6 py-2 bg-teal-600 text-white font-semibold rounded-md hover:bg-teal-700 transition-colors">Registra tu negocio aquí</a>
        </div>
    </footer>

    <script>
        const GOOGLE_SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vScNOmQpXAX-qrXge2DztDAAP2G8m-7ot7q362Z8rHTTa5oj0RHKxqcMMWWYutSc9L7jLncLW4IPzIr/pub?gid=678724048&single=true&output=csv';

        document.addEventListener('DOMContentLoaded', () => {
            const cardContainer = document.getElementById('card-container');
            const loadingIndicator = document.getElementById('loading');
            const noResultsMessage = document.getElementById('no-results');
            const searchInput = document.getElementById('searchInput');
            const categoryFilter = document.getElementById('categoryFilter');

            let allBusinesses = [];

            async function fetchData() {
                try {
                    const response = await fetch(GOOGLE_SHEET_URL);
                    if (!response.ok) throw new Error('Error al cargar datos');
                    const csvText = await response.text();
                    allBusinesses = parseCSV(csvText);
                    populateCategories(allBusinesses);
                    displayBusinesses(allBusinesses);
                } catch (error) {
                    console.error('Error:', error);
                    loadingIndicator.innerHTML = '<p class="text-red-500">Hubo un problema al cargar los datos.</p>';
                } finally {
                    loadingIndicator.style.display = 'none';
                }
            }

            function parseCSV(text) {
                const lines = text.trim().split('\n');
                const headers = lines[0].split(',').map(h => h.trim());
                // Mantenemos los encabezados largos que te están funcionando
                const nameIndex = headers.indexOf('Nombre del Negocio');
                const categoryIndex = headers.indexOf('Categoría');
                const descriptionIndex = headers.indexOf('Descripción Corta');
                const whatsappIndex = headers.indexOf('Número de WhatsApp');
                const socialIndex = headers.indexOf('Enlace a Red Social (Opcional)');
                const imageIndex = headers.indexOf('Enlace de Imagen (Logo o Foto)');
                const approvedIndex = headers.indexOf('Aprobado');

                const businesses = [];
                for (let i = 1; i < lines.length; i++) {
                    const data = lines[i].split(',');
                    if (data[approvedIndex] && data[approvedIndex].trim().toLowerCase() === 'si') {
                        businesses.push({
                            name: data[nameIndex] ? data[nameIndex].trim() : 'Sin Nombre',
                            category: data[categoryIndex] ? data[categoryIndex].trim() : 'Sin Categoría',
                            description: data[descriptionIndex] ? data[descriptionIndex].trim() : '',
                            whatsapp: data[whatsappIndex] ? data[whatsappIndex].trim() : '',
                            social: data[socialIndex] ? data[socialIndex].trim() : '',
                            image: data[imageIndex] ? data[imageIndex].trim() : ''
                        });
                    }
                }
                return businesses;
            }

            // --- ✨ NUEVA FUNCIÓN PARA CREAR EL AVATAR CON INICIALES ---
            function createPlaceholder(name) {
                const initials = name.split(' ').map(word => word[0]).join('').substring(0, 2).toUpperCase();
                // Genera un color basado en el nombre para que sea consistente
                let hash = 0;
                for (let i = 0; i < name.length; i++) {
                    hash = name.charCodeAt(i) + ((hash << 5) - hash);
                }
                const h = hash % 360;
                const bgColor = `hsl(${h}, 35%, 85%)`;
                const textColor = `hsl(${h}, 35%, 35%)`;
                
                return `<div class="w-16 h-16 rounded-full flex-shrink-0 flex items-center justify-center" style="background-color: ${bgColor};">
                            <span class="text-2xl font-bold" style="color: ${textColor};">${initials}</span>
                        </div>`;
            }

            // --- ✨ FUNCIÓN DE VISUALIZACIÓN MODIFICADA ---
            function displayBusinesses(businesses) {
                cardContainer.innerHTML = '';
                noResultsMessage.style.display = businesses.length === 0 ? 'block' : 'none';
                
                businesses.forEach(business => {
                    const whatsappNumber = business.whatsapp.replace(/\D/g, '');
                    const whatsappLink = `https://wa.me/${whatsappNumber}`;

                    // Decide si usar la imagen o el placeholder de iniciales
                    const imageOrPlaceholder = business.image 
                        ? `<img src="${business.image}" alt="Logo de ${business.name}" class="w-16 h-16 rounded-full object-cover flex-shrink-0">`
                        : createPlaceholder(business.name);

                    const card = `
                        <div class="bg-white rounded-lg shadow-md p-5 flex flex-col fade-in transition-all hover:shadow-lg hover:scale-[1.02]">
                            <div class="flex items-center gap-4">
                                ${imageOrPlaceholder}
                                <div class="flex-grow">
                                    <span class="text-xs font-semibold text-teal-600 bg-teal-100 px-2 py-1 rounded-full">${business.category}</span>
                                    <h3 class="text-lg font-bold text-gray-800 mt-1">${business.name}</h3>
                                </div>
                            </div>
                            <p class="text-gray-600 mt-4 text-sm flex-grow">${business.description}</p>
                            <div class="mt-4 pt-4 border-t border-gray-200 flex items-center justify-end gap-3">
                                ${business.social ? `
                                    <a href="${business.social}" target="_blank" class="text-gray-400 hover:text-blue-500" title="Red Social">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 2h-3a5 5 0 0 0-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 0 1 1-1h3z"></path></svg>
                                    </a>` : ''}
                                ${business.whatsapp ? `
                                    <a href="${whatsappLink}" target="_blank" class="flex items-center gap-2 px-4 py-2 bg-green-500 text-white font-semibold text-sm rounded-lg hover:bg-green-600 transition-colors" title="Contactar por WhatsApp">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path></svg>
                                        WhatsApp
                                    </a>` : ''}
                            </div>
                        </div>
                    `;
                    cardContainer.innerHTML += card;
                });
            }

            function populateCategories(businesses) {
                const categories = [...new Set(businesses.map(b => b.category))];
                categories.sort().forEach(category => {
                    if (category && category !== 'Sin Categoría') {
                        const option = document.createElement('option');
                        option.value = category;
                        option.textContent = category;
                        categoryFilter.appendChild(option);
                    }
                });
            }

            function filterResults() {
                const searchTerm = searchInput.value.toLowerCase();
                const selectedCategory = categoryFilter.value;
                const filtered = allBusinesses.filter(b => 
                    (b.name.toLowerCase().includes(searchTerm) || b.description.toLowerCase().includes(searchTerm)) &&
                    (selectedCategory === 'all' || b.category === selectedCategory)
                );
                displayBusinesses(filtered);
            }

            searchInput.addEventListener('input', filterResults);
            categoryFilter.addEventListener('change', filterResults);

            fetchData();
        });
    </script>

</body>
</html>
